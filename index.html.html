
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>EHS Chat Debug</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background: #000; color: #0f0; font-family: monospace; padding: 20px; }
    button { margin: 10px; padding: 10px; font-size: 18px; }
    #log { margin-top: 20px; white-space: pre-wrap; border: 1px solid #0f0; padding: 10px; max-height: 300px; overflow-y: auto; }
  </style>
</head>
<body>

<h1>EHS Chat Debug</h1>
<button onclick="startOffer()">Inizia (Offer)</button>
<button onclick="startAnswer()">Rispondi (Answer)</button>

<div id="log">[LOG]</div>

<script>
const log = (msg) => {
  const logDiv = document.getElementById("log");
  logDiv.textContent += "\n" + msg;
  console.log(msg);
};

const token = "ehs_" + Math.random().toString(16).slice(2, 10);
log("Token stanza: " + token);

const server = "https://ehs-relay.vercel.app/";
let pc = new RTCPeerConnection();
let channel;

function postData(path, data) {
  return fetch(server + path, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data),
  });
}

function getData(path) {
  return fetch(server + path).then(res => res.json());
}

async function startOffer() {
  channel = pc.createDataChannel("chat");
  channel.onopen = () => log("Canale aperto (Offer)");
  channel.onmessage = (e) => log("Messaggio ricevuto: " + e.data);

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  log("Offerta creata");

  await postData(token, offer);
  log("Offerta inviata");

  const poll = setInterval(async () => {
    try {
      const answer = await getData(token);
      if (answer && answer.type === "answer") {
        clearInterval(poll);
        log("Risposta ricevuta");
        await pc.setRemoteDescription(new RTCSessionDescription(answer));
      }
    } catch (err) {
      log("Errore polling risposta: " + err.message);
    }
  }, 1000);
}

async function startAnswer() {
  pc.ondatachannel = (event) => {
    channel = event.channel;
    channel.onmessage = (e) => log("Messaggio ricevuto: " + e.data);
    channel.onopen = () => log("Canale aperto (Answer)");
  };

  try {
    const offer = await getData(token);
    log("Offerta ricevuta");

    await pc.setRemoteDescription(new RTCSessionDescription(offer));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    await postData(token, answer);
    log("Risposta inviata");
  } catch (err) {
    log("Errore ricezione offerta: " + err.message);
  }
}
</script>
</body>
</html>


<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>EHS Chat Debug - Verbose</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background: #000; color: #0f0; font-family: monospace; padding: 20px; }
    button { margin: 10px; padding: 10px; font-size: 18px; }
    #log { margin-top: 20px; white-space: pre-wrap; border: 1px solid #0f0; padding: 10px; max-height: 300px; overflow-y: auto; }
  </style>
</head>
<body>

<h1>EHS Chat Debug (Verbose)</h1>
<button onclick="startOffer()">Inizia (Offer)</button>
<button onclick="startAnswer()">Rispondi (Answer)</button>

<div id="log">[LOG]</div>

<script>
const log = (msg) => {
  const logDiv = document.getElementById("log");
  logDiv.textContent += "\n" + msg;
  console.log(msg);
};

let token;
let pc;
let channel;
const server = "https://ehs-relay.vercel.app/";

async function startOffer() {
  token = "ehs_" + Math.random().toString(16).slice(2, 10);
  log("Token stanza: " + token);

  pc = new RTCPeerConnection();
  channel = pc.createDataChannel("chat");

  // tutto il resto del codice rimane uguale
}

async function postData(path, data) {
  log("[POST] Invio a: " + server + path);
  try {
    const res = await fetch(server + path, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data),
    });
    const text = await res.text();
    log("[POST] Risposta server: " + text);
  } catch (err) {
    log("[POST] Errore: " + err.message);
  }
}

async function getData(path) {
  log("[GET] Chiedo a: " + server + path);
  try {
    const res = await fetch(server + path);
    const json = await res.json();
    log("[GET] Risposta ricevuta");
    return json;
  } catch (err) {
    log("[GET] Errore: " + err.message);
  }
}

async function startOffer() {
  channel = pc.createDataChannel("chat");
  channel.onopen = () => log("Canale aperto (Offer)");
  channel.onmessage = (e) => log("Messaggio ricevuto: " + e.data);

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  log("Offerta creata");

  await postData(token, offer);
  log("Offerta inviata");

  const poll = setInterval(async () => {
    const answer = await getData(token);
    if (answer && answer.type === "answer") {
      clearInterval(poll);
      log("Risposta ricevuta");
      await pc.setRemoteDescription(new RTCSessionDescription(answer));
    }
  }, 1000);
}

async function startAnswer() {
  pc.ondatachannel = (event) => {
    channel = event.channel;
    channel.onmessage = (e) => log("Messaggio ricevuto: " + e.data);
    channel.onopen = () => log("Canale aperto (Answer)");
  };

<!-- Forza aggiornamento GitHub Pages -->
  
  const offer = await getData(token);
  if (!offer || !offer.type) {
    log("Nessuna offerta valida ricevuta");
    return;
  }

  log("Offerta ricevuta");

  await pc.setRemoteDescription(new RTCSessionDescription(offer));
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  await postData(token, answer);
  log("Risposta inviata");
}
</script>
</body>
</html>


<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>EHS-Link WebRTC Auto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background:#111; color:#fff; font-family:sans-serif; padding:20px; text-align:center; }
    input, button, textarea { padding:10px; width:100%; margin:10px 0; border-radius:6px; border:none; }
    button { background:#090; color:#fff; font-weight:bold; }
  </style>
</head>
<body>

<h2>WebRTC Pairing EHS-Link (Auto)</h2>

<p><b>Token EHS generato:</b> <span id="tokenOut">-</span></p>
<p><label><input type="radio" name="role" value="offer" checked> Inizia (Offer)</label>
   <label><input type="radio" name="role" value="answer"> Rispondi (Answer)</label></p>
<button onclick="start()">Avvia</button>

<textarea id="log" rows="10" readonly></textarea>
<input id="outgoing" placeholder="Scrivi un messaggio...">
<button onclick="send()">Invia</button>

<script>
let peer, channel, token;

function log(msg) {
  document.getElementById("log").value += msg + "\n";
}

async function sha256(text) {
  const buf = new TextEncoder().encode(text);
  const hashBuf = await crypto.subtle.digest("SHA-256", buf);
  return Array.from(new Uint8Array(hashBuf)).map(b => b.toString(16).padStart(2, '0')).join('');
}

async function generateToken() {
  const base = "session-blind-key" + Math.floor(Date.now() / 30000);
  const hash = await sha256(base);
  token = "ehs_" + hash.slice(0, 8);
  document.getElementById("tokenOut").innerText = token;
}

async function postData(data) {
  await fetch("https://ehs-relay.vercel.app/" + token, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });
}

async function getData() {
  const res = await fetch("https://ehs-relay.vercel.app/" + token);
  return await res.json();
}

async function start() {
  await generateToken();
  const role = document.querySelector("input[name=role]:checked").value;

  peer = new RTCPeerConnection();
  peer.ondatachannel = e => {
    channel = e.channel;
    channel.onmessage = e => log("Loro: " + e.data);
  };

  if (role === "offer") {
    channel = peer.createDataChannel("ehs");
    channel.onmessage = e => log("Loro: " + e.data);

    peer.onicecandidate = async e => {
      if (!e.candidate) {
        await postData(peer.localDescription);
        log("Offer inviata. Attendi risposta...");
        waitForAnswer();
      }
    };

    const offer = await peer.createOffer();
    await peer.setLocalDescription(offer);
  } else {
    log("Attendi offer...");
    waitForOffer();
  }
}

async function waitForOffer() {
  let tries = 0;
  const interval = setInterval(async () => {
    const data = await getData();
    if (data && data.type === "offer") {
      clearInterval(interval);
      log("Offer ricevuta.");
      await peer.setRemoteDescription(data);

      const answer = await peer.createAnswer();
      await peer.setLocalDescription(answer);

      peer.onicecandidate = async e => {
        if (!e.candidate) {
          await postData(peer.localDescription);
          log("Answer inviata.");
        }
      };
    } else if (++tries > 20) {
      clearInterval(interval);
      log("Timeout. Nessuna offer trovata.");
    }
  }, 2000);
}

async function waitForAnswer() {
  let tries = 0;
  const interval = setInterval(async () => {
    const data = await getData();
    if (data && data.type === "answer") {
      clearInterval(interval);
      await peer.setRemoteDescription(data);
      log("Answer ricevuta. Connessione stabilita!");
    } else if (++tries > 20) {
      clearInterval(interval);
      log("Timeout. Nessuna answer trovata.");
    }
  }, 2000);
}

function send() {
  const msg = document.getElementById("outgoing").value.trim();
  if (!msg || !channel || channel.readyState !== "open") return;
  channel.send(msg);
  log("Tu: " + msg);
  document.getElementById("outgoing").value = "";
}
</script>

</body>
</html>
